---
share: true
---

# Ref

- Original Paper: Faster R-CNN: Towards Real-Time Object Detection with Region Proposal Networks

# Problem

Faster R-CNN 是一种流行的目标检测算法，这个算法对之前的 R-CNN 和 Fast R-CNN 方法进行了改进，尤其是在生成区域提案（region proposals）这一步骤上实现了加速。

# Approach

Faster R-CNN 主要由两个部分组成：

1. 区域提案网络（Region Proposal Network, RPN）：
    - RPN 是 Faster R-CNN 的核心，它是一个全卷积网络（FCN），能够在图像中高效地生成区域提案。这些提案标识出可能包含目标的图像区域。
    - RPN 通过滑动窗口在特征图上快速扫描，使用锚点框（anchor boxes）来预测目标的位置和大小。锚点框是一组不同尺度和比例的框，用于覆盖不同大小和形状的目标。
2. 检测器：
    - 一旦得到区域提案，Fast R-CNN 检测器就会提取每个提案区域的特征，并通过分类器进行分类，同时通过边界框回归器精确地定位目标。

# Architecture  

## Backbone

这是一个预训练的卷积神经网络，如VGG16、ResNet-50等，用于从输入图像中提取特征图。

## Region Proposal Network

RPN 是 Faster R-CNN 的核心，用于在特征图上生成区域提案。它是一个全卷积网络，滑动窗口遍历特征图，通过一系列的锚点框（anchor boxes）来预测物体的位置。

- 锚点框：预定义的一组框，它们有不同的尺寸和比例，以适应不同形状和大小的物体；
- 分类层：每个锚点框会被分类为“前景”（含有物体）或“背景”；
- 回归层：调整锚点框的位置和大小，更精确地匹配真实物体；
- 尽管锚点框本身是固定的，但通过 RPN 的调整，最终生成的区域提案是针对每个特定图像动态生成的，并且它们的形状和大小是根据图像内容优化的；

## RoI Pooling

RoI（Region of Interest）Pooling 层从每个提案区域中提取固定大小的特征区域，这些区域将被用于后续的分类和回归任务。RoI Pooling 能够确保不同大小的提案区域都能输出相同维度的特征。

## Head

提取的固定大小特征图通过一系列全连接层，进行以下两个任务：

- 分类任务：预测提案区域内物体的具体类别；
- 边界框回归：细化提案区域的位置和大小，以更准确地框定物体；

# Training

Faster R-CNN 的训练过程是复杂的，因为它必须同时训练区域提案网络（RPN）和检测网络。以下是 Faster R-CNN 训练流程的概述：

## 预训练骨干网络

首先，通常会用一个预训练的卷积神经网络（如 VGG 或 ResNet）作为特征提取器，也就是所谓的“骨干网络”。这个网络在大型数据集（如 ImageNet）上预训练，以识别各种通用特征。

## 训练区域提案网络（RPN）

接着，用骨干网络的特征图来训练 RPN。RPN 会学习在特征图上的每个位置使用一组固定的锚点框来预测物体的存在和位置。每个锚点会被标记为正样本或负样本，取决于其与真实边界框的 IoU（交并比）。RPN 的训练涉及两个主要任务：

- 锚点框分类：每个锚点框被分类为包含物体（前景）或背景；
- 锚点框回归：调整锚点框的位置，使其更准确地覆盖物体；

## 训练 Fast R-CNN 检测网络

训练好 RPN 后，可以用它生成的提案来训练 Fast R-CNN 检测网络。这个网络会对 RPN 的提案进行分类，并进一步精细化边界框的位置。Fast R-CNN 部分也包含两个任务：

- 提案分类：预测每个提案的类别；
- 边界框回归：精细化提案的位置和大小；

# Inference

Faster R-CNN 的推理流程是将训练好的模型应用于新图像，以检测图像中的物体并定位它们的过程。以下是推理过程的详细步骤：

1. 特征提取：输入图像首先通过骨干网络（例如VGG或ResNet），这是一个深度卷积网络，用于提取图像的特征图。
2. 区域提案生成：特征图被送入区域提案网络（RPN），RPN使用滑动窗口遍历特征图，并通过一系列预定义的锚点框生成物体的候选区域。对于每个锚点框，RPN 预测两个主要内容：一是锚点框是否包含物体（即前景与背景的分类），二是锚点框的位置调整参数（即边界框回归）；
3. 非极大值抑制（NMS）：由 RPN 生成的提案中可能会有大量重叠的区域，通过非极大值抑制（NMS）可以去除这些重叠的提案，只保留得分最高的提案；
4. RoI Pooling：对于每个经过 NMS 处理的提案区域，使用 RoI Pooling 层来从特征图中提取出一个固定大小的特征区块，以便进行后续的分类和边界框回归。
5. 分类和边界框回归：提取的特征区块被送入一系列全连接层（或称为头部网络），这些层对每个提案区域进行分类，并细化其边界框的位置；
6. 最终检测结果：
	- 模型的输出包括每个提案区域的类别标签和调整后的边界框坐标。
	- 对于每个类别，可能会再次应用 NMS，以去除重叠的检测结果，确保每个物体只被检测一次。